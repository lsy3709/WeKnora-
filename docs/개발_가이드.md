# WeKnora 개발 가이드

## 빠른 개발 모드 (권장)

`app`(백엔드) 또는 `frontend`(프론트엔드) 코드를 빈번하게 수정해야 하는 경우, **매번 Docker 이미지를 다시 빌드할 필요 없이** 로컬 개발 모드를 사용할 수 있습니다.

### 방법 1: Make 명령어 사용 (권장)

#### 1. 인프라 서비스 시작

```bash
make dev-start
```

이 명령은 다음 서비스들의 Docker 컨테이너를 실행합니다:
- PostgreSQL (데이터베이스)
- Redis (캐시)
- MinIO (오브젝트 스토리지)
- Neo4j (그래프 데이터베이스)
- DocReader (문서 분석 서비스)
- Jaeger (분산 트레이싱)

#### 2. 백엔드 애플리케이션 시작 (새 터미널)

```bash
make dev-app
```

로컬 환경에서 직접 Go 애플리케이션을 실행합니다. 코드 수정 후 Ctrl+C로 중단하고 다시 실행하면 즉시 반영됩니다.

#### 3. 프론트엔드 시작 (새 터미널)

```bash
make dev-frontend
```

Vite 개발 서버를 시작합니다. 핫 리로드(Hot Reload)를 지원하여 코드 수정 시 브라우저가 자동으로 새로고침됩니다.

#### 4. 서비스 상태 확인

```bash
make dev-status
```

#### 5. 모든 서비스 중지

```bash
make dev-stop
```

### 방법 2: 스크립트 명령어 사용

스크립트를 직접 사용하는 것을 선호한다면:

```bash
# 인프라 시작
./scripts/dev.sh start

# 백엔드 시작 (새 터미널)
./scripts/dev.sh app

# 프론트엔드 시작 (새 터미널)
./scripts/dev.sh frontend

# 로그 확인
./scripts/dev.sh logs

# 모든 서비스 중지
./scripts/dev.sh stop
```

## 접속 주소

### 개발 환경

- **프론트엔드 개발 서버**: http://localhost:5173
- **백엔드 API**: http://localhost:8080
- **PostgreSQL**: localhost:5432
- **Redis**: localhost:6379
- **MinIO Console**: http://localhost:9001
- **Neo4j Browser**: http://localhost:7474
- **Jaeger UI**: http://localhost:16686

## 개발 워크플로우 비교

### ❌ 기존 방식 (느림)

```bash
# 코드 수정 시마다 다음 작업 필요:
sh scripts/build_images.sh -p      # 이미지 다시 빌드 (매우 느림)
sh scripts/start_all.sh --no-pull  # 컨테이너 재시작
```

**소요 시간**: 수정 시마다 2~5분

### ✅ 새로운 방식 (빠름)

```bash
# 최초 실행 (한 번만 필요):
make dev-start

# 나머지 두 개의 터미널에서 각각 실행:
make dev-app       # Go 코드 수정 후 Ctrl+C 재시작 (초 단위)
make dev-frontend  # 프론트엔드 코드 수정 시 자동 핫 리로드 (재시작 불필요)
```

**소요 시간**:
- 최초 실행: 1~2분
- 백엔드 수정: 5~10초 (Go 앱 재시작)
- 프론트엔드 수정: 실시간 반영

## Air를 이용한 백엔드 자동 재시작 (선택 사항)

백엔드 코드 수정 시 자동으로 앱을 재시작하고 싶다면 `air`를 설치할 수 있습니다.

### 1. Air 설치

```bash
go install github.com/cosmtrek/air@latest
```

### 2. 설정 파일 생성

프로젝트 루트 디렉토리에 `.air.toml`을 생성합니다:

```toml
root = "."
testdata_dir = "testdata"
tmp_dir = "tmp"

[build]
  args_bin = []
  bin = "./tmp/main"
  cmd = "go build -o ./tmp/main ./cmd/server"
  delay = 1000
  exclude_dir = ["assets", "tmp", "vendor", "testdata", "frontend", "migrations"]
  exclude_file = []
  exclude_regex = ["_test.go"]
  exclude_unchanged = false
  follow_symlink = false
  full_bin = ""
  include_dir = []
  include_ext = ["go", "tpl", "tmpl", "html", "yaml"]
  include_file = []
  kill_delay = "0s"
  log = "build-errors.log"
  poll = false
  poll_interval = 0
  rerun = false
  rerun_delay = 500
  send_interrupt = false
  stop_on_error = false

[color]
  app = ""
  build = "yellow"
  main = "magenta"
  runner = "green"
  watcher = "cyan"

[log]
  main_only = false
  time = false

[misc]
  clean_on_exit = false

[screen]
  clear_on_rebuild = false
  keep_scroll = true
```

### 3. Air로 시작

```bash
# 프로젝트 루트 디렉토리에서
air
```

이제 Go 코드를 수정하면 자동으로 다시 컴파일되고 재시작됩니다!

## 기타 개발 팁

### 프론트엔드만 수정할 경우

프론트엔드만 수정한다면:

```bash
cd frontend
npm run dev
```

프론트엔드는 http://localhost:8080 에 떠 있는 백엔드 API에 연결됩니다.

### 백엔드만 수정할 경우

백엔드만 수정한다면:

```bash
# 인프라 시작
make dev-start

# 백엔드 실행
make dev-app
```

### 디버깅 모드

#### 백엔드 디버깅

VS Code 또는 GoLand의 디버깅 기능을 사용하여 로컬에서 실행 중인 Go 애플리케이션에 연결합니다.

VS Code 설정 예시 (`.vscode/launch.json`):

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Launch Server",
            "type": "go",
            "request": "launch",
            "mode": "auto",
            "program": "${workspaceFolder}/cmd/server",
            "env": {
                "DB_HOST": "localhost",
                "DOCREADER_ADDR": "localhost:50051",
                "MINIO_ENDPOINT": "localhost:9000",
                "REDIS_ADDR": "localhost:6379",
                "OTEL_EXPORTER_OTLP_ENDPOINT": "localhost:4317",
                "NEO4J_URI": "bolt://localhost:7687"
            },
            "args": []
        }
    ]
}
```

#### 프론트엔드 디버깅

브라우저 개발자 도구를 사용하세요. Vite가 소스 맵(Source Map)을 제공합니다.

## 운영 환경 배포

개발을 완료하고 배포할 준비가 되었을 때 이미지를 빌드합니다:

```bash
# 모든 이미지 빌드
sh scripts/build_images.sh

# 또는 특정 이미지 구성 요소만 빌드
sh scripts/build_images.sh -p  # 백엔드만 빌드
sh scripts/build_images.sh -f  # 프론트엔드만 빌드

# 운영 환경 시작
sh scripts/start_all.sh
```

## 자주 묻는 질문 (FAQ)

### Q: dev-app 실행 시 데이터베이스 연결 오류가 발생합니다.

A: 먼저 `make dev-start`를 실행했는지, 그리고 모든 서비스가 구동될 때까지 약 30초 정도 기다렸는지 확인하세요.

### Q: 프론트엔드 접속 시 CORS 오류가 발생합니다.

A: 프론트엔드의 프록시 설정을 확인하세요. `vite.config.ts`에 올바른 백엔드 주소가 설정되어 있어야 합니다.

### Q: DocReader 서비스를 다시 빌드하고 싶습니다.

A: DocReader는 계속 Docker 이미지를 사용하므로, 수정이 필요한 경우 다시 빌드해야 합니다:

```bash
sh scripts/build_images.sh -d
make dev-restart
```

## 요약

- **일상적인 개발**: `make dev-*` 명령어로 빠른 반복 개발 수행
- **통합 테스트**: `sh scripts/start_all.sh --no-pull`로 전체 환경 테스트
- **운영 배포**: `sh scripts/build_images.sh` + `sh scripts/start_all.sh` 조합 사용
